<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ airline }} – Staff Analytics</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <nav>
        <a href="{{ url_for('admin_home') }}">Home</a>
        <a href="{{ url_for('default_view') }}">Upcoming Flights</a>
        <a href="{{ url_for('passenger_list') }}">Passenger List</a>
        <a href="{{ url_for('staff_analytics') }}">Analytics</a>
        <a href="{{ url_for('logout') }}">Logout</a>
    </nav>

    <div class="container">
        <h1>{{ airline }} – Staff Analytics Dashboard</h1>

        <section>
            <h2>Top Booking Agents – Last 30 Days (by Tickets)</h2>
            {% if top_agents_month_tickets %}
                <table>
                    <thead>
                        <tr>
                            <th>Booking Agent Email</th>
                            <th>Tickets Sold</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in top_agents_month_tickets %}
                            <tr>
                                <td>{{ row.booking_agent_email }}</td>
                                <td>{{ row.tickets_sold }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No booking agent activity in the last 30 days.</p>
            {% endif %}
        </section>

        <section>
            <h2>Top Booking Agents – Last Year (by Tickets)</h2>
            {% if top_agents_year_tickets %}
                <table>
                    <thead>
                        <tr>
                            <th>Booking Agent Email</th>
                            <th>Tickets Sold</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in top_agents_year_tickets %}
                            <tr>
                                <td>{{ row.booking_agent_email }}</td>
                                <td>{{ row.tickets_sold }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No booking agent activity in the last year.</p>
            {% endif %}
        </section>

        <section>
            <h2>Top Booking Agents – Last 30 Days (by Commission)</h2>
            {% if top_agents_month_commission %}
                <table>
                    <thead>
                        <tr>
                            <th>Booking Agent Email</th>
                            <th>Total Commission</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in top_agents_month_commission %}
                            <tr>
                                <td>{{ row.booking_agent_email }}</td>
                                <td>{{ row.commission }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No commission earned in the last 30 days.</p>
            {% endif %}
        </section>

        <section>
            <h2>Top Booking Agents – Last Year (by Commission)</h2>
            {% if top_agents_year_commission %}
                <table>
                    <thead>
                        <tr>
                            <th>Booking Agent Email</th>
                            <th>Total Commission</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in top_agents_year_commission %}
                            <tr>
                                <td>{{ row.booking_agent_email }}</td>
                                <td>{{ row.commission }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No commission earned in the last year.</p>
            {% endif %}
        </section>

        <section>
            <h2>Most Frequent Customer (Last Year)</h2>
            {% if most_freq_cust %}
                <p>
                    <strong>{{ most_freq_cust.customer_email }}</strong> –
                    {{ most_freq_cust.flights_taken }} flights
                </p>
            {% else %}
                <p>No frequent customer data available for the last year.</p>
            {% endif %}
        </section>

        <section>
            <h2>Tickets Sold per Month (Last Year)</h2>
            <div id="ticketsByMonthChart" style="height: 350px;"></div>
        </section>

        <section>
            <h2>Delay vs On-Time Status (Last Year)</h2>
            <div id="statusPieChart" style="height: 350px;"></div>
        </section>

        <section>
            <h2>Top 10 Destinations – Last 3 Months</h2>
            {% if top10_destinations_month %}
                <table>
                    <thead>
                        <tr>
                            <th>Destination</th>
                            <th>Tickets Sold</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in top10_destinations_month %}
                            <tr>
                                <td>{{ row.destination }}</td>
                                <td>{{ row.tickets_sold }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No destination data for the last 3 months.</p>
            {% endif %}
        </section>

        <section>
            <h2>Top 10 Destinations – Last Year</h2>
            {% if top10_destinations_year %}
                <table>
                    <thead>
                        <tr>
                            <th>Destination</th>
                            <th>Tickets Sold</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in top10_destinations_year %}
                            <tr>
                                <td>{{ row.destination }}</td>
                                <td>{{ row.tickets_sold }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No destination data for the last year.</p>
            {% endif %}
        </section>
    </div>

    <script>
        // Tickets per month (bar chart)
        const months = {{ (tix_per_month | map(attribute='month') | list) | tojson }};
        const ticketsSold = {{ (tix_per_month | map(attribute='tickets_sold') | list) | tojson }};

        if (months.length > 0) {
            Plotly.newPlot('ticketsByMonthChart', [{
                x: months,
                y: ticketsSold,
                type: 'bar'
            }], {
                title: 'Tickets Sold per Month (Last 12 Months)',
                xaxis: { title: 'Month (1–12)' },
                yaxis: { title: 'Tickets Sold' }
            });
        }

        // Status pie chart (delay vs on-time)
        const statusLabels = {{ (delay_vs_ontime | map(attribute='status_') | list) | tojson }};
        const statusCounts = {{ (delay_vs_ontime | map(attribute='count') | list) | tojson }};

        if (statusLabels.length > 0) {
            Plotly.newPlot('statusPieChart', [{
                labels: statusLabels,
                values: statusCounts,
                type: 'pie'
            }], {
                title: 'Flight Status Distribution (Last Year)'
            });
        }
    </script>
</body>
</html>
